var DynamicApp=function(){"use strict";function e(){let e={},t=this;function n(n){let r=e[n.type];if(void 0!==r){let e=r.slice(0);for(let r=0,o=e.length;r<o;r++)e[r].call(t,n)}}this.addEventListener=function(t,n){void 0===e[t]&&(e[t]=[]);-1===e[t].indexOf(n)&&e[t].push(n)},this.hasEventListener=function(t,n){return void 0!==e[t]&&-1!==e[t].indexOf(n)},this.removeEventListener=function(t,n){let r=e[t];if(void 0!==r){let e=r.indexOf(n);-1!==e&&r.splice(e,1)}},this.dispatchEvent=n,this.trigger=function(e,r){(r=r||{}).type=e,r.target=r.target||t.target,n(r)},this.target=this}function t(n){let r={},o=!1,i=new e;return r.config=o,r.modules={},r.lazyModules={},r.run=s,r.loadLazyModule=function(e){return new Promise((t,n)=>{r.modules.view.loadDependence(o[e].scripts||[]).catch(n).then(()=>{r.modules.view.loadComponents([o[e].component||""]).catch(n).then(()=>t())})})},r.addEventListener=a,r.removeEventListener=u,i.target=r,function(e){e=e||function(){},t()||document.addEventListener("readystatechange",t);function t(){return"complete"===document.readyState&&(document.removeEventListener("readystatechange",t),e()),"complete"===document.readyState}}(function(){"string"==typeof n?(e=n,r.modules.loader=r.modules.loader||new t.Loader(r),r.modules.loader?r.modules.loader.loadConfig(e).then(s):console.error("Need Loader module to load config")):s(n);var e}),{run:s,addEventListener:a,removeEventListener:u};function s(e){if("object"==typeof o)return console.error("Already initialized"),!1;if("object"!=typeof e)return console.error("Bad config"),!1;r.config=o=e,i.trigger("run"),r.lazyModules=Object.keys(o).filter(e=>0!==e.indexOf("_")&&"app"!==e);let n={},s=Object.keys(o.app.modules).filter(e=>0!==e.indexOf("_")&&"app"!==e);var a,u;s.map(e=>n[e]=e).forEach(e=>{let s=app[e]||new(t[(u=e,u.split(/\W+/g).map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(""))])(r);s.addEventListener("ready",()=>(e=e,delete n[e],void(0===Object.keys(n).length&&(i.trigger("ready"),c())))),s.run(o.app.modules[e]),r.modules[e]=s}),0===s.length&&(i.trigger("ready"),c())}function c(){Object.keys(r.modules).forEach(e=>r.modules[e].start()),document.title=o.app.name,i.trigger("start"),console.log("App is full started",r)}function a(e,t){return i.addEventListener(e,t)}function u(e,t){return i.removeEventListener(e,t)}}class n{constructor(){this.name="",this._dispatcher=new e,this._dispatcher.target=this,this._config=!1}addEventListener(e,t){return this._dispatcher.addEventListener(e,t)}removeEventListener(e,t){return this._dispatcher.removeEventListener(e,t)}_trigger(e,t){(t=t||{}).type=e,this._dispatcher.dispatchEvent(t)}run(){}start(){}}class r extends n{constructor(e){super(),this.name="router",this.api=e,this.router=new function(){if(this===window)return new r;let e=this,t=[],n=!1,o=function(){};function i(n){n=(n="string"==typeof n?n:window.location.hash)||"/";let r=t.filter(function(e){return function(e,t){let n=s(t),r=e.rule;if("function"==typeof e.rule)return e.rule(n);if(n===r||"*"===r)return!0;if("string"==typeof r&&!/:(\w+|\d+)/.test(r))return!1;return(r=r instanceof RegExp?r:new RegExp(r.replace(/:(\w+|\d+)/g,"(\\w+|\\d+)"))).test(n)}(e,n)});return r.forEach(function(e){!function(e,t){"function"==typeof e.action&&e.action("string"==typeof e.rule?c(t,e.rule):{})}(e,n)}),0===r.length&&o(n,c(n,"")),e}function s(e){let t="string"==typeof e?e.replace(/\B#/,""):window.location.hash;return t.replace(/\/$/,"").replace(/\B#/,"")}function c(e,t){let n=s(e),r={},o=t.match(/:(\w+|\d+)/g)||[],i=t.replace(/:(\w+|\d+)+/g,"\n").split("\n")||[];return i.forEach(function(e){n=n.replace(e,"\n")}),n=n.split("\n").filter(function(e){return""!==e}),o.forEach(function(e,t){let o=n[t],i=parseFloat(o);e=e.replace(":",""),r[e]=isNaN(i)?o:i}),r}this.listen=function(t){n=t=void 0===t||!!t,window[t?"addEventListener":"removeEventListener"]("popstate",i,!1),t&&i();return e},this.check=i,this.add=function(n,r){r="function"==typeof r?r:void 0,void 0!==n&&t.push({rule:n,action:r});return e},this.remove=function(n,r){return t=t.filter(function(e){return e.rule!==n||void 0!==r&&e.action!==r}),e},this.redirect=function(t){return location.hash="#"+t.replace(/\B#/,""),e},this.setHash=function(t){window.removeEventListener("popstate",i,!1),location.hash="#"+t.replace(/\B#/,""),n&&window.addEventListener("popstate",i,!1);return e},this.notfound=function(t){return o="function"==typeof t?t:o,e},this.on=function(){return e},this.off=function(){return e},this.getMap=function(){return t}},this.lazyModulesChecker=[]}run(e){"object"==typeof e&&(this._config=e||[],this._trigger("run"),e.forEach(e=>this.router.add(e.href,t=>this.openPage(e.page,t))),this.api.lazyModules.forEach(e=>{let t=this.api.config[e];this.router.add(t.link,t=>this.loadLazyPage(e,t))}),this.router.notfound(()=>console.log("NOT FOUND")),this._trigger("ready"))}start(){this.router.listen(),this._trigger("start")}openPage(e,t){let n=this.api.modules.view;n.viewData("currentView",e),n.viewData("currentViewParams",t)}loadLazyPage(e,t){let n=this.api.modules.view;this.lazyModulesChecker.indexOf(e)>-1?(n.viewData("currentView",e),n.viewData("currentViewParams",t)):(this.api.loadLazyModule(e).then(()=>{this.lazyModulesChecker.push(e),n.viewData("currentView",e),n.viewData("currentViewParams",t)}).catch(e=>console.log("FUCK....",e)),this.api.modules.view.viewData("currentView","loader"))}}t.version="0.1",t.EventDispatcher=e,t.Loader=class extends n{constructor(e){super(),this.name="loader",this.api=e}run(e){"object"==typeof e&&(this._config=e||{},this._trigger("run"),this._trigger("ready"))}loadConfig(e){return fetch(e).then(function(e){return e.ok?e.text():(console.error("Bad config request"),"{}")}).then(function(e){try{return JSON.parse(e)}catch(t){return e}}).then(e=>"string"==typeof e?function(e){try{window.Piper.decode(e)}catch(t){return console.error("Bad config piper decode"),e}}(e):e)}require(e){let t=this.api.settings.root,n=!0;return e=e instanceof Array?e:[e||""],new Promise((t,o)=>{Promise.all(e.map(r)).then(e=>n?t(e):o())});function r(e){return this.loadScript(t+e+".js").then(()=>e,()=>{n=!1,console.error("Module "+e+" not loaded")})}}loadScript(e){return new Promise(function(t,n){let r=document.createElement("script");r.src=e,r.onload=t,r.onerror=n,document.body.appendChild(r)})}loadStyle(e){let t=document.createElement("link");return t.rel="stylesheet",t.href=e,document.head.appendChild(t),t}},t.Router=r,t.View=class extends n{constructor(e){super(),this.name="router",this.api=e,this.loader=e.modules.loader,this.vueApp=!1}run(e){"object"==typeof e&&(this.config=e||{},this._trigger("run"),this.loadStyles(this.config.styles),this.loadDependence(this.config.dependencies).then(e=>{e?this.loadComponents(this.config.components).then(e=>{e?this.initVue():console.error("Some components not loaded")}):console.error("Some dependencies not loaded")}))}loadStyles(e){(e||[]).forEach(this.loader.loadStyle)}loadDependence(e){e=(e||[]).slice();let t=this.loader.loadScript;return new Promise((n,r)=>{0!==e.length?function o(i){if(!i)return n(!0);t(i).then(()=>o(e.shift())).catch(()=>r(!1))}(e.shift()):n(!0)})}initVue(){let e=document.querySelector(this.config.element),t=e.parentElement,n=document.createElement("index");n.setAttribute(":root-scope","rootScope"),t.insertBefore(n,e),e.remove(),this.vueApp=new Vue({el:n,data:function(){return{rootScope:{currentView:"home",currentViewParams:{}}}},components:{}}),window.vueApp=this.vueApp,this._trigger("ready")}loadComponents(e){let t=this;return e=e||[],Promise.all(e.map(function(e){return fetch(e).then(t=>t.ok?t.text():console.error(e,"components not found")).then(t=>(function(e,t){return{name:e.split("/").pop().replace(".vue",""),tpl:n("template"),script:n("script"),style:n("style")};function n(e){let n=new RegExp("\\<"+e+"\\>[\\s\\S]+\\<\\/"+e+"\\>","g"),r=new RegExp("\\<"+e+"\\>|\\<\\/"+e+"\\>","g");return((t.match(n)||[])[0]||"{}").replace(r,"")}})(e,t)).then(n)})).catch(e=>console.error("Bad component",e)).then(e=>e);function n(e){let n=document.createElement("style");n.innerHTML=e.style,document.head.appendChild(n),window.exports={},window.eval("(function(){'use strict';"+e.script.replace(/\r\n/g,"")+"})()");let r=exports;return delete window.exports,t.addComponents(e.name,e.tpl,r)}}addComponents(e,t,n){(n=function(e){let t={},n={data:function(){return t},methods:{},props:e.props||[],computed:e.computed||{},watch:e.watch||{}};return delete e.props,delete e.computed,delete e.watch,["beforeCreate","created","beforeMount","mounted","beforeUpdate","updated","activated","deactivated","beforeDestroy","destroyed","errorCaptured"].forEach(function(t){n[t]=e[t]||function(){},delete e[t]}),Object.keys(e).forEach(function(r){"function"==typeof e[r]?n.methods[r]=e[r]:t[r]=e[r],delete e[r]}),n.methods.getRootScope=function(){return r.vueApp.rootScope},n}(n)).template=t;let r=this;return Vue.component(e,n)}start(){this.setFocusStatus(this.config.focus),this._trigger("start")}viewData(e,t){if(void 0===t)return this.vueApp.rootScope[e];this.vueApp.rootScope[e]=t}setFocusStatus(e){e=e||0;let t=document.body;function n(){setTimeout(function(){t.classList.add("focus")},e)}window.addEventListener("focus",n),window.addEventListener("blur",function(){t.classList.remove("focus")}),n()}};const o=function(){if("object"!=typeof document)return!1;let e=document.querySelectorAll("script"),t=e[e.length-1],n="";if(t&&t.src&&(t.src.split("/").slice(0,-1).join("/"),t.dataset.config)){n=t.dataset.config;try{n=JSON.parse(n)}catch(e){}return n}return!1}();return o&&(window.app=t(o)),t}();
